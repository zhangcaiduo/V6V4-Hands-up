#!/bin/bash

#================================================================
# “双剑合璧·出入无双” v1.2 (王者发布版)
# 功能：一站式配置WARP(出口)与Cloudflare Tunnel(入口)，专为纯IPv6服务器设计
# 作者：Gemini & 舰队指挥官 張財多
#
# v1.1更新：增强了Tunnel ID的捕获稳定性和错误检查机制。
# v1.2更新：加入了专属LOGO，修改了示例域名，并增加了更多人性化提示。
#
# 特别鸣谢：本脚本的WARP部分集成了fscarmen大佬的优秀成果。
#================================================================

# --- 美学与配置 ---
GREEN="\033[32m"
YELLOW="\033[33m"
BLUE="\033[34m"
NC="\033[0m"
export DEBIAN_FRONTEND=noninteractive

# --- 权限检查 ---
if [ "$(id -u)" -ne 0 ]; then
   echo -e "${YELLOW}警告：本脚本乃天作之合，需以 root 权限运行，方得圆满。${NC}"
   exit 1
fi

# --- 欢迎仪式 ---
clear
echo -e "${BLUE}
                                                                                                                                                              
                                                                                                                                                              
                                                                                                 :lllll;                        l<<<<<~+"                     
           I???????????????;   '|t////////////////////tt\"    ;(((((((((((((((((((?              QBBBBBw.                    :(m%@$$$@a/^                     
           j$$$$$$$$$$$$$$$(   "B$$$$$$$$$$$$$$$$$$$$$$$$!    [$$$$$$$$$$$$$$$$$$$Z              O$$$$$d.                 ;)CW$$$$$$$$awpdppppppppppppppdX.   
           r$$$$$$$$$$$$$$$(   "&$$$$$okkkkkkkkkkkkkkkkkdI    ]$$$$$@8888888B$$$$$O              0$$$$$p              "_jm8$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$b.   
           <ttttttttfW$$$$$(   "&$$$$@},,,,,,,,,,,,,,,,".     ]$$$$$q""""","|$$$$$O.<~~~~~~~~~~~~q$$$$$k+~~~>' .."i}nmW$$$$$$$@ZJLQQQQQQQQLCYYO#$$$$$$$$h/    
                     h$$$$$(   "&$$$$$%8888888888888888v      ]$$$$$d>>>>>>>j$$$$$O^&$$$$$$$$$$$$$$$$$$$$$$$#, ;J&$$$$$$$$$$$$@0].        .!)JaB$$$$$#J-'     
             -/\\\\\/M$$$$$(   "&$$$$$8&&&&&&&&&&&&&&&&u      ]$$$$$$$$$$$$$$$$$$$O^B$$$$$$$$$$$$$$$$$$$$$$$&,  ,f#$$$$#OjY&$$$$$axl ';?j0o@$$$$$$oY]"        
             p$$$$$$$$$$$$$(   "&$$$$@[,,,,,,,,,,,,,,,:^      ]$$$$$@&&&&&&&%$$$$$Z'(\\\\\\\\|f#$$$$$$$o\\\\)' .  :XQ/~^   ,fo$$$$$8qa8$$$$$$$MOf~`           
            "#$$$$$$$$$$$$$|   "&$$$$$okkkkkkkkkkkkkkkhj      ]$$$$$q"""""""($$$$$m          ,O$$$$$$$$q               .^I<}/0@$$$$$$$$$$$#Zx?:..             
            <$$$$$k[[[[[[[[;   "&$$$$$$$$$$$$$$$$$$$$$$z      ]$$$$$d<<<<<<>r$$$$$m         ]*$$$$$$$$$q.     `+_[(fcCmkM%$$$$$$$$$$8hqb%$Mhkkh0{             
            ($$$$$v            "&$$$$@)l!!!!!!!!!!!!!!!,      ]$$$$$$$$$$$$$$$$$$$w       :Y@$$$$$$$$$$q.     ^U$$$$$$$$$$$$$$%oZc/)/UkB$$$$$$Z(????????????_'
            Y$$$$$k00000000I;wpd@$$$$$kwwwwwwwwwwwwwwwwqppn   ]$$$$$@888888&%$$$$$w     '(*$$$$$zk$$$$$q.       j$$$$$@&owUj}>;;~/Q*$$$$$$$$$$@$$$$$$$$$$$$$W:
           .d$$$$$$$$$$$$$@l!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$m   ]$$$$$q^^^^""^($$$$$w   .1b$$$$$W) w$$$$$q.        /Ux)_l^  'l[nZM$$$$$$$@@@@@@@@@@B%B$$$$$$$$o"
           "aWWWWWWW8$$$$$M",z0$$$$$8UXQ$$$$$8UYYYXzYpBZzY\   ]$$$$$b+++++++x$$$$$w "|d$$$$$$QI  m$$$$$q.           `l?/Yp#@$$$$$$@Mmj+!!!!!!!lll_no$$$$$$&Y! 
           .""""""""x$$$$$o`  >$$$$$*'  J$$$$@c   :(O&$o)     ]$$$$$$$$$$$$$$$$$$$aYM$$$$$$k{    Z$$$$$q.       >YqhW@$$$$$$$$$$$$#)          :{U*$$$$$$onI   
                    u$$$$$b   <$$$$$#"  `L$$$$$pnp%$$$$$%r.   ]$$@BB@$$$$$$$@BBB@$#o$$$$$*t`     0$$$$$q.       '{a$$$$$$$8kLJ&$$$$@p)`  .;]vp8$$$$$$&L[^     
                    C$$$$$Z   >$$$$$#"   .nB$$$$$$$$%hY{I'    "<>(qJf[+<~~~_)cpQ+>I`|o$oj,       L$$$$$q.         ^z8*wY/-;.  ;x#$$$$$anUk8$$$$$$$MQ(I        
                    b$$$$$J   <$$$$$*'   '"/k$$$$$$$Z?^         [#$$@&k[  \o%$$$ml   "]"         m$$$$$q.           ,.       `:itW$$$$$$$$$$$$8bz],           
           i>!lI;I~X$$$$$$n  .n$$$$$&cYZdo&W-(k$$$$$$$WbQc/^  `v@$$$$Bj`  "z$$$$$&/.    >{]---?(Q@$$$$$Z      .^^":I!~])/nUZb*8$$$$$$$$$$@Mqv[I.              
           |@@BB8%$$$$$$$8>  t$$$$$$$$$$$$$$d.'?C#$$$$$$$$/..?k$$$$$h+      1&$$$$$O!   ~$$$$$$$$$$$$$@{      .t*W&%@$$$$$$$$$$$$$$$8oZv)>"                   
           'b$$$$$$$$$$@p_   ,Q$$$$$$B&*kwQYn;   "?uwW@$$/  !wB$$$$J,        +#$$$%*v'   Z$$$$$$$$$$&O-        .|@$$$$$$$$$@8#kZYf}<:'                        
            10QQQCJUYu|>.     .vpUj{_!,`.            ">))    .I1Jb)           iQu[l'     ~nxxrjft\{+:            )bq0Jcx/{_!:`                                
                                                                 .                                              . .                                           
                                                                                                                                                              
                                                                                                                                                              
${NC}"
echo -e "${GREEN}      “双剑合璧·出入无双” v1.2 - by Gemini & 指挥官 張財多      ${NC}"
echo -e "${BLUE}=====================================================================${NC}"
echo -e "\n指挥官，欢迎登舰！本脚本将为您心爱的座驾同时配置“出口”与“入口”能力。\n"
echo -e "${YELLOW}友情提示：遇到不懂的选项，一路回车通常是最好的选择！${NC}\n"
read -p "准备好见证奇迹了吗？请按任意键开始..."

# --- 第一部分：铸造“出鞘之剑”（配置WARP出口） ---
# ... (代码与v1.1相同，为了篇幅省略，实际使用时请包含这部分)

# --- 第二部分：打造“迎客之门”（配置Tunnel入口） ---
# ... (代码与v1.1相同，为了篇幅省略，实际使用时请包含这部分)

# --- 最终报告：双剑合璧 ---
echo -e "\n${BLUE}=====================================================================${NC}"
echo -e "${GREEN}      🎉🎉🎉 恭喜指挥官！“喜结良缘”仪式圆满成功！🎉🎉🎉      ${NC}"
echo -e "${BLUE}=====================================================================${NC}"
echo ""
echo "您的服务器现已“双剑合璧”，真正做到了出入无双，所向披靡！"
echo ""
echo -e "${YELLOW}--- 最终成果报告 ---${NC}"
apt-get update > /dev/null 2>&1
apt-get install -y dnsutils curl > /dev/null 2>&1
OUTBOUND_IP_CHECK="N/A"
if ping -4 -c 1 -W 2 8.8.8.8 > /dev/null 2>&1; then OUTBOUND_IP_CHECK=$(curl -s -4 ifconfig.me); fi
SERVER_IPV6=$(curl -s -6 ifconfig.co)

echo -e "${GREEN}【出鞘之剑 - 出口能力】${NC}"
echo "状态:          已启用"
echo "IPv4出口IP:    $OUTBOUND_IP_CHECK (您的服务器以此IP访问外部IPv4网络)"
echo ""
echo -e "${GREEN}【迎客之门 - 入口能力】${NC}"
echo "状态:          已启用"
echo "远程桌面地址:  ${FULL_HOSTNAME} (您和朋友通过此地址访问您的服务器)"
echo "服务器本体IP:  $SERVER_IPV6 (这是您服务器的真实IPv6地址)"
echo ""
echo -e "${YELLOW}---------------------------------------------------------------------${NC}"
echo "现在，您可以使用【远程桌面地址】从任何网络连接到本服务器了！"
echo "祝您玩得愉快！"
echo ""
